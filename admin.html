<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel MY Store</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #25D366;
            --whatsapp: #25D366;
            --danger: #ef4444;
            --success: #10b981;
            --dark: #1f2937;
            --light: #f8fafc;
            --gray: #9ca3af;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--light);
            min-height: 100vh;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 2rem 1rem;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary), var(--whatsapp));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .logo i {
            font-size: 2rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: var(--gray);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .nav-item i {
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            margin-left: 250px;
            width: calc(100% - 250px);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-header h1 {
            font-size: 2.2rem;
            background: linear-gradient(45deg, var(--primary), var(--whatsapp));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 2px solid var(--danger);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-2px);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, var(--primary), var(--whatsapp));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
        }

        /* Products Table */
        .table-container {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px;
            color: var(--gray);
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .product-image-cell {
            width: 80px;
        }

        .product-image-small {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 5px;
        }

        .edit-btn {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .edit-btn:hover {
            background: #3b82f6;
            color: white;
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Add Product Form */
        .add-product-form {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 15px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 900px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gray);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .price-input {
            position: relative;
        }

        .price-input:before {
            content: "Rs. ";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 600;
            z-index: 1;
        }

        .price-input input {
            padding-left: 50px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 2px solid #f59e0b;
        }

        .btn-secondary:hover {
            background: #f59e0b;
            color: var(--dark);
        }

        .btn-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 2px solid var(--success);
        }

        .btn-success:hover {
            background: var(--success);
            color: white;
        }

        /* Variation Management Styles */
        .variation-manager {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .variation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .variation-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .variation-item {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .variation-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 1rem;
        }

        .variation-input {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .variation-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .remove-variation {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-variation:hover {
            background: var(--danger);
            color: white;
        }

        /* Image Gallery */
        .image-gallery-upload {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .gallery-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: move;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .gallery-image:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .gallery-upload-btn {
            width: 100%;
            height: 120px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gallery-upload-btn:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        /* Specifications */
        .specifications-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .spec-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .spec-input input {
            flex: 1;
        }

        .remove-spec {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-spec:hover {
            background: var(--danger);
            color: white;
        }

        /* Category-specific fields */
        .category-specific-fields {
            display: none;
            background: rgba(15, 23, 42, 0.5);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-specific-fields.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        /* Variation Type Selector */
        .variation-types {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
        }

        .variation-type-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .variation-type-checkbox:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .variation-type-checkbox input[type="checkbox"] {
            margin: 0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            padding: 2rem;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        /* Edit Modal Specific */
        .edit-image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 1rem;
        }

        .edit-gallery-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .edit-gallery-image.active {
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
        }

        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .variation-list {
                grid-template-columns: 1fr;
            }
            
            .add-product-form {
                padding: 1rem;
            }
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: slideIn 0.3s ease-out;
        }

        .currency-symbol {
            color: var(--secondary);
            font-weight: 600;
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary);
        }

        .drag-handle {
            cursor: move;
            position: absolute;
            top: 5px;
            left: 5px;
            color: var(--gray);
            background: rgba(0, 0, 0, 0.5);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .badge-primary {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fab fa-whatsapp"></i>
                WhatsApp Admin
            </div>
            <nav>
                <a href="#dashboard" class="nav-item active" id="navDashboard">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </a>
                <a href="#products" class="nav-item" id="navProducts">
                    <i class="fas fa-box"></i>
                    Products
                </a>
                <a href="#add-product" class="nav-item" id="navAddProduct">
                    <i class="fas fa-plus-circle"></i>
                    Add Product
                </a>
                <a href="index.html" class="nav-item">
                    <i class="fas fa-store"></i>
                    View Store
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="admin-header">
                <h1>WhatsApp Store Admin</h1>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="dashboard-section">
                <div class="stats-grid">
                    <div class="stat-card animate-in">
                        <i class="fas fa-box"></i>
                        <h3>Total Products</h3>
                        <div class="value" id="totalProducts">0</div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.1s">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Total Orders</h3>
                        <div class="value" id="totalOrders">0</div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.2s">
                        <i class="fas fa-rupee-sign"></i>
                        <h3>Total Revenue</h3>
                        <div class="value" id="totalRevenue">Rs. 0</div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.3s">
                        <i class="fas fa-layer-group"></i>
                        <h3>With Variations</h3>
                        <div class="value" id="totalVariations">0</div>
                    </div>
                </div>

                <!-- Ad Control Panel -->
                <div class="table-container" style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="margin: 0; font-size: 1.4rem;">Ad Playlist (Video/Image)</h2>
                        <span style="color: var(--gray); font-size: 0.9rem;">Plays continuously in dashboard view</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start;">
                        <div>
                            <label style="color: var(--gray); font-weight: 600; display:block; margin-bottom:6px;">Ad URL</label>
                            <input type="text" id="adUrl" class="form-control" placeholder="Paste image or video URL (mp4/webm)">
                        </div>
                        <div>
                            <label style="color: var(--gray); font-weight: 600; display:block; margin-bottom:6px;">Type</label>
                            <select id="adType" class="form-control">
                                <option value="video">Video</option>
                                <option value="image">Image</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; display:flex; justify-content:flex-start; gap:10px;">
                        <button class="btn btn-primary" id="addAdBtn"><i class="fas fa-plus"></i> Add to Playlist</button>
                    </div>
                    
                    <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="background: rgba(15,23,42,0.6); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px; max-height: 220px; overflow-y:auto;">
                            <h4 style="margin-bottom: 10px;">Playlist</h4>
                            <ul id="adList" style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px;"></ul>
                        </div>
                        <div id="adPlayerWrapper" style="background: rgba(15,23,42,0.6); border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px;">
                            <h4 style="margin-bottom: 10px;">Live Preview</h4>
                            <div id="adPlayer" style="width:100%; min-height:180px; display:grid; place-items:center; color: var(--gray);">
                                <span>Waiting for ads...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products Section -->
            <section id="products" class="products-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.8rem;">Manage Products</h2>
                    <div style="display: flex; gap: 10px;">
                        <select id="categoryFilter" class="form-control" style="width: 200px;" onchange="filterProducts()">
                            <option value="all">All Categories</option>
                            <!-- Categories will be populated -->
                        </select>
                        <input type="text" id="productSearch" class="form-control" placeholder="Search products..." style="width: 250px;" oninput="searchProducts()">
                    </div>
                </div>
                <div class="table-container">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Variations</th>
                                <th>Price (PKR)</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Add Product Section -->
            <section id="add-product" class="add-product-section" style="display: none;">
                <h2 style="margin-bottom: 1.5rem; font-size: 1.8rem;">Add New Product</h2>
                <div class="add-product-form animate-in">
                    <form id="productForm">
                        <!-- Basic Info -->
                        <div class="form-group">
                            <label for="productName">Product Name *</label>
                            <input type="text" id="productName" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">Description *</label>
                            <textarea id="productDescription" class="form-control" rows="4" required></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productPrice">Base Price (PKR) *</label>
                                <div class="price-input">
                                    <input type="number" id="productPrice" class="form-control" min="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productCategory">Category *</label>
                                <select id="productCategory" class="form-control" required onchange="toggleCategoryFields()">
                                    <option value="">Select Category</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="clothing">Clothing</option>
                                    <option value="footwear">Footwear</option>
                                    <option value="perfumes">Perfumes</option>
                                    <option value="bags">Bags</option>
                                    <option value="watches">Watches</option>
                                    <option value="jewelry">Jewelry</option>
                                    <option value="home">Home & Living</option>
                                    <option value="sports">Sports</option>
                                    <option value="beauty">Beauty</option>
                                    <option value="books">Books</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Category Specific Fields -->
                        <div id="categorySpecificFields" class="category-specific-fields"></div>

                        <!-- Specifications -->
                        <div class="form-group">
                            <div class="variation-header">
                                <h3 style="margin: 0;">Specifications</h3>
                                <button type="button" class="btn btn-secondary" onclick="addSpecification()">
                                    <i class="fas fa-plus"></i> Add Specification
                                </button>
                            </div>
                            <div class="specifications-grid" id="specificationsContainer">
                                <!-- Specifications will be added here -->
                            </div>
                        </div>

                        <!-- Image Gallery -->
                        <div class="form-group">
                            <div class="variation-header">
                                <h3 style="margin: 0;">Product Images *</h3>
                                <span style="font-size: 0.9rem; color: var(--gray);">Upload multiple images</span>
                            </div>
                            <div class="image-gallery-upload" id="imageGallery">
                                <div class="gallery-upload-btn" onclick="document.getElementById('galleryUpload').click()">
                                    <i class="fas fa-plus-circle" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                                    <p>Add Images</p>
                                    <p style="font-size: 0.8rem; color: var(--gray);">JPG, PNG, GIF (Max 5MB)</p>
                                </div>
                            </div>
                            <input type="file" id="galleryUpload" multiple accept="image/*" style="display: none;" onchange="handleGalleryUpload(event)">
                        </div>

                        <!-- Variations -->
                        <div class="form-group">
                            <div class="variation-manager">
                                <div class="variation-header">
                                    <h3 style="margin: 0;">Product Variations</h3>
                                    <div>
                                        <button type="button" class="btn btn-secondary" onclick="addVariation()" style="margin-right: 10px;">
                                            <i class="fas fa-plus"></i> Add Variation
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="generateVariations()">
                                            <i class="fas fa-magic"></i> Auto Generate
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Variation Types -->
                                <div class="variation-types">
                                    <label class="variation-type-checkbox">
                                        <input type="checkbox" value="size" onchange="toggleVariationType('size')">
                                        Size
                                    </label>
                                    <label class="variation-type-checkbox">
                                        <input type="checkbox" value="color" onchange="toggleVariationType('color')">
                                        Color
                                    </label>
                                    <label class="variation-type-checkbox">
                                        <input type="checkbox" value="capacity" onchange="toggleVariationType('capacity')">
                                        Capacity (ml)
                                    </label>
                                    <label class="variation-type-checkbox">
                                        <input type="checkbox" value="storage" onchange="toggleVariationType('storage')">
                                        Storage
                                    </label>
                                    <label class="variation-type-checkbox">
                                        <input type="checkbox" value="material" onchange="toggleVariationType('material')">
                                        Material
                                    </label>
                                </div>

                                <!-- Variations List -->
                                <div class="variation-list" id="variationsList">
                                    <!-- Variations will be added here -->
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="display: flex; gap: 15px; justify-content: center;">
                            <button type="submit" class="btn btn-primary" id="submitBtn" style="padding: 15px 40px;">
                                <i class="fas fa-plus"></i> Add Product
                            </button>
                            <button type="button" class="btn btn-secondary" id="resetForm" style="padding: 15px 40px;">
                                <i class="fas fa-redo"></i> Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Product</h2>
                <button class="close-modal" id="closeEditModal">&times;</button>
            </div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                
                <div class="form-group">
                    <label for="editProductName">Product Name *</label>
                    <input type="text" id="editProductName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editProductDescription">Description *</label>
                    <textarea id="editProductDescription" class="form-control" rows="4" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editProductPrice">Base Price (PKR) *</label>
                        <div class="price-input">
                            <input type="number" id="editProductPrice" class="form-control" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editProductCategory">Category *</label>
                        <select id="editProductCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="electronics">Electronics</option>
                            <option value="clothing">Clothing</option>
                            <option value="footwear">Footwear</option>
                            <option value="perfumes">Perfumes</option>
                            <option value="bags">Bags</option>
                            <option value="watches">Watches</option>
                            <option value="jewelry">Jewelry</option>
                            <option value="home">Home & Living</option>
                            <option value="sports">Sports</option>
                            <option value="beauty">Beauty</option>
                            <option value="books">Books</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Edit Image Gallery -->
                <div class="form-group">
                    <label>Product Images</label>
                    <div class="edit-image-gallery" id="editImageGallery">
                        <!-- Images will be loaded here -->
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="file" id="editGalleryUpload" multiple accept="image/*" style="display: none;" onchange="handleEditGalleryUpload(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('editGalleryUpload').click()">
                            <i class="fas fa-plus"></i> Add More Images
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Product
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API configuration
        const API_BASE_URL = (() => {
            const origin = window.location.origin.replace(/\/$/, '');
            return origin.startsWith('http') ? `${origin}/api` : 'http://localhost:3000/api';
        })();

        // Admin authentication
        const ADMIN_PASSWORD = "admin123";
        
        // Check if admin is logged in
        if (!localStorage.getItem('adminLoggedIn')) {
            const password = prompt("Enter Admin Password:");
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
            } else {
                alert("Invalid password!");
                window.location.href = "index.html";
            }
        }

        // Global Variables
        let products = [];
        let categories = new Set();
        let variations = [];
        let galleryImages = [];
        let editingProductId = null;
        let selectedVariationTypes = new Set();
        let draggedImageIndex = null;
        let adPlaylist = [];
        let adRotationTimer = null;
        const ADS_API = `${API_BASE_URL || 'http://localhost:3000/api'}/ads`;

        // DOM Elements
        const navDashboard = document.getElementById('navDashboard');
        const navProducts = document.getElementById('navProducts');
        const navAddProduct = document.getElementById('navAddProduct');
        const logoutBtn = document.getElementById('logoutBtn');
        const dashboardSection = document.getElementById('dashboard');
        const productsSection = document.getElementById('products');
        const addProductSection = document.getElementById('add-product');
        const productForm = document.getElementById('productForm');
        const productsTableBody = document.getElementById('productsTableBody');
        const categoryFilter = document.getElementById('categoryFilter');
        const productSearch = document.getElementById('productSearch');
        const editModal = document.getElementById('editModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const editProductForm = document.getElementById('editProductForm');
        const resetFormBtn = document.getElementById('resetForm');
        const adUrlInput = document.getElementById('adUrl');
        const adTypeSelect = document.getElementById('adType');
        const addAdBtn = document.getElementById('addAdBtn');
        const adListEl = document.getElementById('adList');
        const adPlayer = document.getElementById('adPlayer');
        const adPlayerWrapper = document.getElementById('adPlayerWrapper');
        
        // Stats elements
        const totalProductsEl = document.getElementById('totalProducts');
        const totalOrdersEl = document.getElementById('totalOrders');
        const totalRevenueEl = document.getElementById('totalRevenue');
        const totalVariationsEl = document.getElementById('totalVariations');

        // Format PKR price with commas
        function formatPrice(price) {
            return price ? price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";
        }

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            dashboardSection.style.display = 'none';
            productsSection.style.display = 'none';
            addProductSection.style.display = 'none';
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            
            // Add active class to selected nav item
            document.querySelector(`[href="#${sectionId}"]`).classList.add('active');
            
            // Load data for the section
            if (sectionId === 'dashboard') {
                loadDashboardStats();
            } else if (sectionId === 'products') {
                loadProducts();
            } else if (sectionId === 'add-product') {
                resetForm();
            }
        }

        // Load products from backend
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE_URL}/products`);
                if (!response.ok) throw new Error('Failed to fetch products');
                
                const result = await response.json();
                if (!result.success || !result.data) {
                    throw new Error(result.error || result.message || 'Failed to load products');
                }

                // API returns {products, pagination}
                const payload = Array.isArray(result.data) 
                    ? result.data 
                    : (result.data.products || []);

                products = payload;
                extractCategories();
                populateCategoryFilter();
                renderProductsTable();
                loadDashboardStats();
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Failed to load products. Please check if server is running.');
                products = [];
                renderProductsTable();
            }
        }

        // Extract unique categories from products
        function extractCategories() {
            categories = new Set();
            products.forEach(product => {
                if (product.category) {
                    categories.add(product.category);
                }
            });
        }

        // Populate category filter
        function populateCategoryFilter() {
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilter.appendChild(option);
            });
        }

        // Filter products by category
        function filterProducts() {
            const category = categoryFilter.value;
            const searchTerm = productSearch.value.toLowerCase();
            
            let filtered = products;
            
            if (category !== 'all') {
                filtered = filtered.filter(p => p.category === category);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm))
                );
            }
            
            renderProductsTable(filtered);
        }

        // Search products
        function searchProducts() {
            filterProducts();
        }

        // Render products table
        function renderProductsTable(filteredProducts = products) {
            productsTableBody.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--gray); padding: 2rem;">
                            <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <h3>No products found</h3>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredProducts.forEach(product => {
                const hasVariations = product.variations && product.variations.length > 0;
                const variationCount = hasVariations ? product.variations.length : 0;
                const totalStock = hasVariations 
                    ? product.variations.reduce((sum, v) => sum + (v.stock || 0), 0)
                    : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="product-image-cell">
                        <img src="${product.images?.[0] || '/uploads/default.jpg'}" 
                             alt="${product.name}" 
                             class="product-image-small"
                             onerror="this.src='https://via.placeholder.com/60x60/1e293b/ffffff?text=IMG'">
                    </td>
                    <td>
                        <div style="font-weight: 600;">${product.name}</div>
                        <div style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                            ${product.description ? product.description.substring(0, 60) + '...' : ''}
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-primary">${product.category || 'N/A'}</span>
                    </td>
                    <td>
                        ${hasVariations ? 
                            `<span class="badge badge-success">${variationCount} variation${variationCount > 1 ? 's' : ''}</span>` : 
                            '<span class="badge">No variations</span>'
                        }
                    </td>
                    <td>
                        <span class="currency-symbol">Rs.</span> ${formatPrice(product.price)}
                    </td>
                    <td>
                        ${hasVariations ? 
                            `<span class="badge ${totalStock > 0 ? 'badge-success' : 'badge-warning'}">${totalStock} in stock</span>` :
                            `<span class="badge badge-success">In stock</span>`
                        }
                    </td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${product.id}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete-btn" data-id="${product.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                productsTableBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.target.closest('button').dataset.id);
                    openEditModal(productId);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.target.closest('button').dataset.id);
                    deleteProduct(productId);
                });
            });
        }

        // Load dashboard statistics
        function loadDashboardStats() {
            totalProductsEl.textContent = products.length;
            
            // Calculate variations count
            const variationsCount = products.reduce((sum, product) => 
                sum + (product.variations ? product.variations.length : 0), 0
            );
            totalVariationsEl.textContent = variationsCount;
            
            // Mock data for orders and revenue (in a real app, this would come from backend)
            const totalOrders = parseInt(localStorage.getItem('totalOrders')) || Math.floor(Math.random() * 100) + 50;
            const totalRevenue = parseInt(localStorage.getItem('totalRevenue')) || Math.floor(Math.random() * 1000000) + 500000;
            
            totalOrdersEl.textContent = totalOrders;
            totalRevenueEl.textContent = `Rs. ${formatPrice(totalRevenue)}`;
        }

        // ================== ADS (Video/Image) ==================
        async function loadAds() {
            try {
                const res = await fetch(ADS_API);
                const result = await res.json();
                if (res.ok && result.success) {
                    adPlaylist = result.data || [];
                } else {
                    adPlaylist = [];
                }
            } catch (e) {
                console.error('Failed to load ads', e);
                adPlaylist = [];
            }
        }

        function renderAdList() {
            adListEl.innerHTML = '';
            if (adPlaylist.length === 0) {
                adListEl.innerHTML = '<li style="color: var(--gray);">No ads yet. Add a video or image URL.</li>';
                return;
            }
            adPlaylist.forEach((ad, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <div style="font-weight:700;">${ad.title || (ad.type === 'video' ? 'Video Ad' : 'Image Ad')}</div>
                        <div style="font-size:0.85rem; color: var(--gray);">${ad.type?.toUpperCase?.() || ''}  ${ad.url}</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="action-btn btn-success" data-index="${index}" data-action="play"><i class="fas fa-play"></i></button>
                        <button class="action-btn delete-btn" data-index="${index}" data-id="${ad.id || ''}" data-action="delete"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                adListEl.appendChild(li);
            });
        }

        function renderAdPlayer(activeIndex = 0) {
            if (adPlaylist.length === 0) return;
            const ad = adPlaylist[activeIndex % adPlaylist.length];
            adPlayer.innerHTML = '';

            if (ad.type === 'video') {
                const video = document.createElement('video');
                video.src = ad.url;
                video.autoplay = true;
                video.muted = true;
                video.loop = adPlaylist.length === 1; // loop if only one
                video.playsInline = true;
                video.controls = false;
                video.style.width = '100%';
                video.style.borderRadius = '10px';
                video.addEventListener('ended', () => {
                    if (adPlaylist.length > 1) playNextAd();
                });
                adPlayer.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = ad.url;
                img.alt = ad.title || 'Ad';
                img.style.width = '100%';
                img.style.borderRadius = '10px';
                adPlayer.appendChild(img);
            }
        }

        function playNextAd() {
            if (adPlaylist.length === 0) return;
            currentAdIndex = (currentAdIndex + 1) % adPlaylist.length;
            renderAdPlayer(currentAdIndex);
        }

        let currentAdIndex = 0;
        function startAdRotation() {
            if (adRotationTimer) clearInterval(adRotationTimer);
            // show first
            currentAdIndex = 0;
            renderAdPlayer(currentAdIndex);
            // rotate if more than one
            if (adPlaylist.length > 1) {
                adRotationTimer = setInterval(playNextAd, 9000);
            }
        }

        // Toggle category-specific fields
        function toggleCategoryFields() {
            const category = document.getElementById('productCategory').value;
            const container = document.getElementById('categorySpecificFields');
            
            container.innerHTML = '';
            container.classList.remove('active');
            
            if (!category) return;
            
            let fieldsHTML = '';
            
            switch(category) {
                case 'perfumes':
                    fieldsHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fragrance Type</label>
                                <input type="text" class="form-control" id="perfumeFragrance" placeholder="e.g., Lavender, Rose">
                            </div>
                            <div class="form-group">
                                <label>Duration (hours)</label>
                                <input type="text" class="form-control" id="perfumeDuration" placeholder="e.g., 24, 48">
                            </div>
                            <div class="form-group">
                                <label>Gender</label>
                                <select class="form-control" id="perfumeGender">
                                    <option value="">Select Gender</option>
                                    <option value="men">Men</option>
                                    <option value="women">Women</option>
                                    <option value="unisex">Unisex</option>
                                </select>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'clothing':
                    fieldsHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fabric</label>
                                <input type="text" class="form-control" id="clothingFabric" placeholder="e.g., Cotton, Silk">
                            </div>
                            <div class="form-group">
                                <label>Fit</label>
                                <select class="form-control" id="clothingFit">
                                    <option value="">Select Fit</option>
                                    <option value="slim">Slim</option>
                                    <option value="regular">Regular</option>
                                    <option value="loose">Loose</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Care Instructions</label>
                                <input type="text" class="form-control" id="clothingCare" placeholder="e.g., Machine Wash">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'electronics':
                    fieldsHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Brand</label>
                                <input type="text" class="form-control" id="electronicsBrand" placeholder="e.g., Samsung, Apple">
                            </div>
                            <div class="form-group">
                                <label>Model</label>
                                <input type="text" class="form-control" id="electronicsModel" placeholder="e.g., Galaxy S23, iPhone 14">
                            </div>
                            <div class="form-group">
                                <label>Warranty</label>
                                <input type="text" class="form-control" id="electronicsWarranty" placeholder="e.g., 1 Year">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'footwear':
                    fieldsHTML = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Material</label>
                                <input type="text" class="form-control" id="footwearMaterial" placeholder="e.g., Leather, Canvas">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select class="form-control" id="footwearType">
                                    <option value="">Select Type</option>
                                    <option value="sneakers">Sneakers</option>
                                    <option value="formal">Formal</option>
                                    <option value="sports">Sports</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Closure</label>
                                <input type="text" class="form-control" id="footwearClosure" placeholder="e.g., Lace-up, Zipper">
                            </div>
                        </div>
                    `;
                    break;
            }
            
            if (fieldsHTML) {
                container.innerHTML = fieldsHTML;
                container.classList.add('active');
            }
        }

        // Collect specifications from form
        function collectSpecifications() {
            const specs = {};
            
            // Collect from specifications container
            const specInputs = document.querySelectorAll('.spec-input');
            specInputs.forEach(input => {
                const key = input.querySelector('.spec-key')?.value.trim();
                const value = input.querySelector('.spec-value')?.value.trim();
                if (key && value) {
                    specs[key] = value;
                }
            });
            
            // Add category-specific specifications
            const category = document.getElementById('productCategory').value;
            switch(category) {
                case 'perfumes':
                    if (document.getElementById('perfumeFragrance')?.value) specs.fragrance = document.getElementById('perfumeFragrance').value;
                    if (document.getElementById('perfumeDuration')?.value) specs.duration = document.getElementById('perfumeDuration').value;
                    if (document.getElementById('perfumeGender')?.value) specs.gender = document.getElementById('perfumeGender').value;
                    break;
                case 'clothing':
                    if (document.getElementById('clothingFabric')?.value) specs.fabric = document.getElementById('clothingFabric').value;
                    if (document.getElementById('clothingFit')?.value) specs.fit = document.getElementById('clothingFit').value;
                    if (document.getElementById('clothingCare')?.value) specs.care = document.getElementById('clothingCare').value;
                    break;
                case 'electronics':
                    if (document.getElementById('electronicsBrand')?.value) specs.brand = document.getElementById('electronicsBrand').value;
                    if (document.getElementById('electronicsModel')?.value) specs.model = document.getElementById('electronicsModel').value;
                    if (document.getElementById('electronicsWarranty')?.value) specs.warranty = document.getElementById('electronicsWarranty').value;
                    break;
                case 'footwear':
                    if (document.getElementById('footwearMaterial')?.value) specs.material = document.getElementById('footwearMaterial').value;
                    if (document.getElementById('footwearType')?.value) specs.type = document.getElementById('footwearType').value;
                    if (document.getElementById('footwearClosure')?.value) specs.closure = document.getElementById('footwearClosure').value;
                    break;
            }
            
            return specs;
        }

        // Add specification input
        function addSpecification() {
            const container = document.getElementById('specificationsContainer');
            const specCount = container.querySelectorAll('.spec-input').length;
            
            if (specCount >= 10) {
                alert('Maximum 10 specifications allowed');
                return;
            }
            
            const specDiv = document.createElement('div');
            specDiv.className = 'spec-input';
            specDiv.innerHTML = `
                <input type="text" class="spec-key form-control" placeholder="Key (e.g., Brand)">
                <input type="text" class="spec-value form-control" placeholder="Value (e.g., Nike)">
                <button type="button" class="remove-spec" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(specDiv);
        }

        // Handle gallery upload
        function handleGalleryUpload(event) {
            const files = Array.from(event.target.files);
            const maxImages = 10;
            
            if (galleryImages.length + files.length > maxImages) {
                alert(`Maximum ${maxImages} images allowed. You can add ${maxImages - galleryImages.length} more images.`);
                return;
            }
            
            files.forEach(file => {
                if (!file.type.match('image.*')) {
                    alert(`File ${file.name} is not an image. Skipping...`);
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert(`File ${file.name} is too large. Maximum size is 5MB.`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    galleryImages.push(imageData);
                    updateImageGallery();
                };
                reader.onerror = function() {
                    alert(`Error reading file ${file.name}. Please try again.`);
                };
                reader.readAsDataURL(file);
            });
            
            // Reset file input
            event.target.value = '';
        }

        // Update image gallery display
        function updateImageGallery() {
            const galleryContainer = document.getElementById('imageGallery');
            galleryContainer.innerHTML = '';
            
            galleryImages.forEach((imageData, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.position = 'relative';
                imgContainer.draggable = true;
                imgContainer.ondragstart = (e) => {
                    draggedImageIndex = index;
                    e.dataTransfer.setData('text/plain', index);
                    e.target.classList.add('dragging');
                };
                imgContainer.ondragover = (e) => e.preventDefault();
                imgContainer.ondrop = (e) => {
                    e.preventDefault();
                    const toIndex = index;
                    if (draggedImageIndex !== null && draggedImageIndex !== toIndex) {
                        reorderImages(draggedImageIndex, toIndex);
                    }
                    e.target.classList.remove('dragging');
                };
                imgContainer.ondragend = (e) => {
                    e.target.classList.remove('dragging');
                };
                
                imgContainer.innerHTML = `
                    <div class="drag-handle">
                        <i class="fas fa-arrows-alt"></i>
                    </div>
                    <img src="${imageData}" class="gallery-image" alt="Product Image ${index + 1}">
                    <button class="remove-variation" onclick="removeGalleryImage(${index})" style="top: 5px; right: 5px;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                galleryContainer.appendChild(imgContainer);
            });
            
            // Add upload button
            const uploadBtn = document.createElement('div');
            uploadBtn.className = 'gallery-upload-btn';
            uploadBtn.onclick = () => document.getElementById('galleryUpload').click();
            uploadBtn.innerHTML = `
                <i class="fas fa-plus-circle" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                <p>Add Images</p>
                <p style="font-size: 0.8rem; color: var(--gray);">${galleryImages.length}/${10} images</p>
            `;
            galleryContainer.appendChild(uploadBtn);
        }

        // Remove gallery image
        function removeGalleryImage(index) {
            if (confirm('Are you sure you want to remove this image?')) {
                galleryImages.splice(index, 1);
                updateImageGallery();
            }
        }

        // Reorder images
        function reorderImages(fromIndex, toIndex) {
            const [movedImage] = galleryImages.splice(fromIndex, 1);
            galleryImages.splice(toIndex, 0, movedImage);
            updateImageGallery();
        }

        // Toggle variation type
        function toggleVariationType(type) {
            const checkbox = document.querySelector(`input[value="${type}"]`);
            
            if (checkbox.checked) {
                selectedVariationTypes.add(type);
                // Add this type to all existing variations
                variations.forEach(variation => {
                    if (!variation[type]) {
                        variation[type] = '';
                    }
                });
            } else {
                selectedVariationTypes.delete(type);
                // Remove this type from all existing variations
                variations.forEach(variation => {
                    delete variation[type];
                });
            }
            
            renderVariations();
        }

        // Add a new variation
        function addVariation() {
            if (selectedVariationTypes.size === 0) {
                alert('Please select at least one variation type (Size, Color, etc.)');
                return;
            }
            
            const basePrice = parseInt(document.getElementById('productPrice').value) || 0;
            const newVariation = {
                price: basePrice,
                stock: 10
            };
            
            // Add selected variation types
            selectedVariationTypes.forEach(type => {
                newVariation[type] = '';
            });
            
            variations.push(newVariation);
            renderVariations();
        }

        // Auto generate variations based on selected types
        function generateVariations() {
            if (selectedVariationTypes.size === 0) {
                alert('Please select variation types first');
                return;
            }
            
            variations = [];
            
            // Define options for each type
            const typeOptions = {
                size: ['S', 'M', 'L', 'XL'],
                color: ['Black', 'White', 'Blue', 'Red', 'Green'],
                capacity: ['50ml', '100ml', '150ml', '200ml'],
                storage: ['64GB', '128GB', '256GB', '512GB'],
                material: ['Cotton', 'Polyester', 'Leather', 'Silk']
            };
            
            // Get selected types as array
            const types = Array.from(selectedVariationTypes);
            
            // Generate combinations (for simplicity, we'll generate limited combinations)
            if (types.length === 1) {
                // Single type variations
                const type = types[0];
                const options = typeOptions[type] || ['Option 1', 'Option 2', 'Option 3'];
                const basePrice = parseInt(document.getElementById('productPrice').value) || 0;
                
                options.forEach((option, index) => {
                    variations.push({
                        [type]: option,
                        price: basePrice + (index * 500), // Increment price for different options
                        stock: Math.floor(Math.random() * 20) + 5
                    });
                });
            } else if (types.length === 2) {
                // Two type combinations (limited to 6 variations)
                const [type1, type2] = types;
                const options1 = typeOptions[type1] || ['S', 'M', 'L'];
                const options2 = typeOptions[type2] || ['Black', 'White'];
                const basePrice = parseInt(document.getElementById('productPrice').value) || 0;
                
                let count = 0;
                for (const opt1 of options1.slice(0, 3)) {
                    for (const opt2 of options2.slice(0, 2)) {
                        if (count >= 6) break;
                        variations.push({
                            [type1]: opt1,
                            [type2]: opt2,
                            price: basePrice + (count * 300),
                            stock: Math.floor(Math.random() * 15) + 3
                        });
                        count++;
                    }
                }
            } else {
                // More than 2 types - just create 3 sample variations
                const basePrice = parseInt(document.getElementById('productPrice').value) || 0;
                for (let i = 0; i < 3; i++) {
                    const variation = { price: basePrice + (i * 500), stock: Math.floor(Math.random() * 10) + 2 };
                    types.forEach(type => {
                        const options = typeOptions[type] || ['Option 1', 'Option 2'];
                        variation[type] = options[i % options.length];
                    });
                    variations.push(variation);
                }
            }
            
            renderVariations();
        }

        // Render variations
        function renderVariations() {
            const container = document.getElementById('variationsList');
            container.innerHTML = '';
            
            if (variations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <i class="fas fa-layer-group" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>No variations added yet</p>
                        <p style="font-size: 0.9rem;">Select variation types above and click "Add Variation"</p>
                    </div>
                `;
                return;
            }
            
            variations.forEach((variation, index) => {
                const variationItem = document.createElement('div');
                variationItem.className = 'variation-item';
                
                // Create input fields for each variation type
                let inputsHTML = '';
                const types = Object.keys(variation).filter(key => key !== 'price' && key !== 'stock');
                
                types.forEach(type => {
                    inputsHTML += `
                        <input type="text" 
                               class="variation-input" 
                               placeholder="${type.charAt(0).toUpperCase() + type.slice(1)}"
                               value="${variation[type] || ''}"
                               oninput="updateVariation(${index}, '${type}', this.value)">
                    `;
                });
                
                // Add price and stock inputs
                inputsHTML += `
                    <div class="price-input" style="grid-column: 1 / -1;">
                        <input type="number" 
                               class="variation-input" 
                               placeholder="Price"
                               value="${variation.price || ''}"
                               oninput="updateVariation(${index}, 'price', this.value)">
                    </div>
                    <input type="number" 
                           class="variation-input" 
                           placeholder="Stock"
                           value="${variation.stock || ''}"
                           oninput="updateVariation(${index}, 'stock', this.value)">
                `;
                
                variationItem.innerHTML = `
                    <div class="variation-input-group">
                        ${inputsHTML}
                    </div>
                    <button type="button" class="remove-variation" onclick="removeVariation(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    <div style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;">
                        SKU: ${generateSKU(variation, index)}
                    </div>
                `;
                container.appendChild(variationItem);
            });
        }

        // Generate SKU for variation
        function generateSKU(variation, index) {
            const productId = products.length + 1;
            let sku = `PROD${productId.toString().padStart(3, '0')}`;
            
            Object.keys(variation).forEach(key => {
                if (key !== 'price' && key !== 'stock') {
                    const value = variation[key];
                    if (value) {
                        sku += `-${key.substring(0, 2).toUpperCase()}${value.substring(0, 2).toUpperCase()}`;
                    }
                }
            });
            
            return sku + `-${(index + 1).toString().padStart(2, '0')}`;
        }

        // Update variation
        function updateVariation(index, key, value) {
            if (variations[index]) {
                if (key === 'price' || key === 'stock') {
                    variations[index][key] = parseInt(value) || 0;
                } else {
                    variations[index][key] = value;
                }
            }
        }

        // Remove variation
        function removeVariation(index) {
            if (confirm('Are you sure you want to remove this variation?')) {
                variations.splice(index, 1);
                renderVariations();
            }
        }

        // Reset form completely
        function resetForm() {
            // Reset form fields
            productForm.reset();
            
            // Reset global variables
            variations = [];
            galleryImages = [];
            selectedVariationTypes.clear();
            
            // Reset checkboxes
            document.querySelectorAll('.variation-type-checkbox input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // Reset UI elements
            document.getElementById('specificationsContainer').innerHTML = `
                <div class="spec-input">
                    <input type="text" class="spec-key form-control" placeholder="Key (e.g., Brand)">
                    <input type="text" class="spec-value form-control" placeholder="Value (e.g., Nike)">
                    <button type="button" class="remove-spec" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.getElementById('categorySpecificFields').innerHTML = '';
            document.getElementById('categorySpecificFields').classList.remove('active');
            
            updateImageGallery();
            renderVariations();
        }

        // Add new product
        async function addProduct(productData) {
            try {
                // Disable submit button
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                
                // Validate required fields
                if (galleryImages.length === 0) {
                    alert('Please upload at least one product image');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }
                
                // Collect all data
                const fullProductData = {
                    name: productData.name,
                    description: productData.description,
                    price: parseInt(productData.price) || 0,
                    category: document.getElementById('productCategory').value,
                    images: galleryImages,
                    specifications: collectSpecifications(),
                    variations: variations.length > 0 ? variations : []
                };
                
                console.log('Sending product data:', fullProductData);
                
                // Send to backend
                const response = await fetch(`${API_BASE_URL}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(fullProductData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${errorText}`);
                }
                
                const result = await response.json();
                if (!result.success || !result.data) {
                    throw new Error(result.error || result.message || 'Failed to add product');
                }
                
                const newProduct = result.data;
                
                // Add to local products array
                if (newProduct) {
                    products.push(newProduct);
                }
                
                // Show success message
                alert('Product added successfully!');
                
                // Switch to products view
                showSection('products');
                
            } catch (error) {
                console.error('Error adding product:', error);
                alert(`Error adding product: ${error.message}. Please check console for details.`);
            } finally {
                // Re-enable submit button
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Product';
            }
        }

        // Open edit modal
        async function openEditModal(productId) {
            editingProductId = productId;
            const product = products.find(p => p.id === productId);
            
            if (!product) {
                alert('Product not found!');
                return;
            }
            
            // Populate form fields
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductDescription').value = product.description;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductCategory').value = product.category || 'other';
            
            // Populate image gallery
            const editGallery = document.getElementById('editImageGallery');
            editGallery.innerHTML = '';
            
            const images = product.images || [];
            images.forEach((img, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.position = 'relative';
                imgContainer.innerHTML = `
                    <img src="${img}" class="edit-gallery-image" 
                         onclick="setPrimaryImage(${index})"
                         onerror="this.src='https://via.placeholder.com/100x100/1e293b/ffffff?text=IMG'">
                    ${index === 0 ? '<div style="position: absolute; top: 5px; left: 5px; background: var(--primary); color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem;">Primary</div>' : ''}
                    <button class="remove-variation" onclick="removeEditImage(${index})" style="top: 5px; right: 5px;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                editGallery.appendChild(imgContainer);
            });
            
            editModal.classList.add('active');
        }

        // Set primary image in edit mode
        function setPrimaryImage(index) {
            // This would be implemented when editing product images
            alert('Feature coming soon: You can reorder images to set primary');
        }

        // Remove image in edit mode
        function removeEditImage(index) {
            // This would be implemented when editing product images
            alert('Feature coming soon: Image removal in edit mode');
        }

        // Handle edit gallery upload
        function handleEditGalleryUpload(event) {
            // This would be implemented when editing product images
            alert('Feature coming soon: Adding more images in edit mode');
            event.target.value = '';
        }

        // Update product
        async function updateProduct(productId, productData) {
            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });
                
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || result.message || 'Failed to update product');
                }

                const updatedProduct = result.data || productData;
                
                // Update in local array
                const index = products.findIndex(p => p.id === productId);
                if (index !== -1) {
                    products[index] = updatedProduct;
                }
                
                alert('Product updated successfully!');
                editModal.classList.remove('active');
                renderProductsTable();
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Error updating product. Please try again.');
            }
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (!response.ok || !result.success) {
                    throw new Error(result.error || result.message || 'Failed to delete product');
                }
                
                // Remove from local array
                products = products.filter(p => p.id !== productId);
                
                // Update UI
                renderProductsTable();
                loadDashboardStats();
                
                alert('Product deleted successfully!');
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product. Please try again.');
            }
        }

        // Event Listeners
        navDashboard.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('dashboard');
        });

        navProducts.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('products');
        });

        navAddProduct.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('add-product');
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('adminLoggedIn');
            window.location.href = 'index.html';
        });

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: document.getElementById('productPrice').value
            };
            
            await addProduct(productData);
        });

        resetFormBtn.addEventListener('click', resetForm);

        closeEditModal.addEventListener('click', () => {
            editModal.classList.remove('active');
        });

        editProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('editProductName').value,
                description: document.getElementById('editProductDescription').value,
                price: parseInt(document.getElementById('editProductPrice').value),
                category: document.getElementById('editProductCategory').value,
                // Note: In a full implementation, you would also send updated images
            };
            
            await updateProduct(editingProductId, productData);
        });

        // Close modal when clicking outside
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                editModal.classList.remove('active');
            }
        });

        // Ads: add new
        addAdBtn.addEventListener('click', async () => {
            const url = (adUrlInput.value || '').trim();
            const type = adTypeSelect.value;
            if (!url) {
                alert('Please enter an ad URL (image or video).');
                return;
            }
            try {
                const res = await fetch(ADS_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, url })
                });
                const result = await res.json();
                if (!res.ok || !result.success) throw new Error(result.error || 'Failed to add ad');
                await loadAds();
                renderAdList();
                startAdRotation();
                adUrlInput.value = '';
            } catch (e) {
                alert(`Failed to add ad: ${e.message}`);
            }
        });

        // Ads: play/delete actions
        adListEl.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const idx = parseInt(btn.dataset.index);
            const action = btn.dataset.action;
            if (Number.isNaN(idx)) return;
            if (action === 'delete') {
                const adId = btn.dataset.id;
                if (!adId) return;
                fetch(`${ADS_API}/${adId}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(async (result) => {
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to delete ad');
                        }
                        await loadAds();
                        renderAdList();
                        startAdRotation();
                    })
                    .catch(err => alert(`Failed to delete ad: ${err.message}`));
            }
            if (action === 'play') {
                currentAdIndex = idx;
                renderAdPlayer(currentAdIndex);
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl + S to save (in add product form)
            if ((e.ctrlKey || e.metaKey) && e.key === 's' && addProductSection.style.display !== 'none') {
                e.preventDefault();
                document.getElementById('submitBtn').click();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                editModal.classList.remove('active');
            }
        });

        // Initialize
        showSection('dashboard');
        loadProducts();
        loadAds().then(() => {
            renderAdList();
            startAdRotation();
        });
    </script>
</body>
</html>